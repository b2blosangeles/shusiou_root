<!DOCTYPE html>
<html>
<head>
    <title>加密语言通信 {($room)?$room:''}</title>
	<meta charset="utf-8" />
	
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.1/annyang.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
	<script src="/js/pingball.js"></script>
	<script>	
		let p = new _PINGBALL_('p'), room = '{$room}';
		function turnOffSR() {
			//annyang.pause();
			annyang.abort();
			$('.status_off').show();
			$('.status_on').hide();				
		}
		function turnOnSR(init) {
			//if (init) { 
				annyang.start();
			//} else {
			//	annyang.resume();
			//}
			$('.status_on').show();
			$('.status_off').hide();			
		}	
		let _ITV = null;
		let soundstarted = 0, soundresult = 0, err = '', SRdetected = null, SRrecongnized = false;
		let stime = new Date().getTime(), ptime = 0;

		
		// p.sendToRoom(room, {SRERROR: 'NoVoiceTimeout'}, function(data) {});
		
			annyang.addCallback('error', function() {
				
				p.sendToRoom(room, {SRERROR: 'NoVoiceTimeout'}, function(data) {});
			});
		
			annyang.addCallback('end', function() {
				
				if (!SRrecongnized && (SRdetected)) {
					clearInterval(_ITV);
					p.sendToRoom(room, {SRERROR: 'VoiceWrong', voice : SRdetected}, function(data) {
					
					});
					turnOffSR() 
				}
			});
			annyang.addCallback('soundstart', function(v) {
			  	console.log('sound detected');
				console.log(v);
				soundstarted = 1;
			});

			annyang.addCallback('result', function(v) {
				SRdetected = v;
			});		
		let setup_annyang = function(cmds) {
			soundstarted = 0; soundresult = 0; err = ''; SRdetected = null; SRrecongnized = false;
			stime = new Date().getTime(), ptime = 0;
			var commands = {};

			function monitor() {
				ptime = new Date().getTime()
				// console.log('==== ' + ptime  + ' ===');
				if (ptime - stime > 6000 && !soundstarted) {
					p.sendToRoom(room, {SRERROR: 'NoVoiceTimeout'}, function(data) {});
					clearInterval(_ITV);
					turnOffSR();
					return true;
				}
				if ((soundstarted) &&  ptime - stime > 10000) {
					clearInterval(_ITV);
					turnOffSR();
				//	console.log('----SRdetected---');
					
					console.log(SRdetected);
					if (!SRdetected) {
						p.sendToRoom(room, {SRERROR: 'NoVoiceTimeout'}, function(data) {});
					} 
					/*
					else {
						p.sendToRoom(room, {SRERROR: 'VoiceWrong', voice : SRdetected}, function(data) {});
					}
					*/
				}
			}
			clearInterval(_ITV);
			
			// _ITV = setInterval(
			//	monitor, 500
			//)
			for (var i=0; i < cmds.length; i++) {
				let cmd = cmds[i];
				commands[cmd] = function() {
					SRrecongnized = true;
				//	console.log('====B=====');
					clearInterval(_ITV);
					p.sendToRoom(room, {SRRELEASE: true}, function(data) {});
					turnOffSR() 	
				};
			}
			//annyang.removeCallback();

			annyang.removeCommands();
			annyang.addCommands(commands);
			annyang.setLanguage('en-US');
			annyang.start({ autoRestart: false});
			turnOnSR()
		}
		
		
		function afterConnection() {};
		
		p.init({ 
			link : '//{$commlink}/',
			onConnect : function(socket) {
				p.sendToRoom(room, null, function(data) {});
				//turnOnSR(1);  turnOffSR()
			}, 
			onClientMessage : function(incomeData) {
				console.log('===>incomeData.data<===');
				console.log(incomeData.data);
				if ((incomeData.data) && (incomeData.data.SR)) {
					setup_annyang(incomeData.data.SR);
				}
			},
			afterTimeout : function(data) {
				console.log('Timeout ==>');
				console.log(data);
			}
		});
			
		
	</script>
	<style>
		.status_on { color:darkgreen }
		.status_off { color:darkorange }
	</style>
</head>
	
<body style="text-align:center"  onunload="onUnload()">
	<i class="fa fa-microphone status_on" aria-hidden="true" style="font-size:3em; display:none;"></i>
	<i class="fa fa-microphone-slash status_off" aria-hidden="true" style="font-size:3em;"></i>
	<br/><br/>
	<div id="income_info" style="font-size:0.6em;"></div>
</body>
</html>
