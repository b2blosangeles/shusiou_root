<!DOCTYPE html>
<html>
<head>
    <title>加密语言通信 {($room)?$room:''}</title>
	<meta charset="utf-8" />
	
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.1/annyang.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
	<script src="//comm1_dev.shusiou.win/js/pingball.js"></script>
	<script>	
		let p = new _PINGBALL_('p');
		
		let setup_annyang = function(cmds) {
			var commands = {};
			for (var i=0; i < cmds.length; i++) {
				let cmd = cmds[i];
				commands[cmd] = function() {
					alert(cmd);
				};
			}
			annyang.addCallback('end', function() {
				console.log('--annyang.isListening()-CC->');
				console.log(annyang.isListening());
			});
			annyang.addCallback('error', function(err) {
				console.log(err);
				return true;
				annyang.abort(function() {});
				setTimeout(
					function() {
						console.log('--annyang.isListening()-->');
						console.log(annyang.isListening());
					}, 2000
				
				);
						console.log('--annyang.isListening()-AA->');
						console.log(annyang.isListening());
				
				alert(111);
					
			});

			annyang.addCallback('resultMatch', function(userSaid, commandText, phrases) {
				console.log('===BBB==='); 
				console.log(userSaid); // sample output: 'hello'
				console.log(commandText); // sample output: 'hello (there)'
				console.log(phrases); // sample output: ['hello', 'halo', 'yellow', 'polo', 'hello kitty']
			});

			annyang.addCommands(commands);
			annyang.setLanguage('en-US');
			// annyang.start({ autoRestart: true});
			annyang.start();		
		}
		
		
		function afterConnection() {
			setup_annyang(['good', 'nice']);
			p.sendToRoom('niu', null, function(data) {});
			/*
			console.log('--- *3** ---' );

			p.leaveRoom('niu', function(data) {
				console.log('leaveRoom . ---> ');
				console.log(data);					
			});
			*/
			for (var i = 0; i < 6; i++) {
				p.sendToRoom('niu', {niu:'N -' + i}, function(data) {
				//	console.log('sendToSocketId . ---> ');
				//	console.log(data);
				});
			}
		};
		
		p.init({ 
			link : 'https://comm1_dev.shusiou.win/',
			onConnect : function(socket) {
				console.log('---socket.id--A->');
				console.log(socket.id);
				afterConnection();
			}, 
			onClientMessage : function(incomeData) {
				console.log('---onClientMessage--->');
				console.log(incomeData);
			},
			/*
			onClientData : function(incomeData, socket) {
				
				switch (incomeData.data.cmd) {
					case 'voiceRecong' :	
						document.getElementById('income_info').innerHTML = 
							JSON.stringify(incomeData.data.voiceRecong);
						setup_annyang(incomeData.data.voiceRecong);
						break;
						
					case 'stop' :
						annyang.abort();
						$('.fa-microphone').removeClass('status_on').addClass('status_off');
						document.getElementById('income_info').innerHTML =  'stopped';
						break	
					
					default:	
				}
			},*/
			afterTimeout : function(data) {
				console.log('===afterTimeout====');
				console.log(data);
			}
		});
			
		
	</script>
	<style>
		.status_on { color:darkgreen }
		.status_off { color:darkred }
	</style>
</head>
	
<body style="text-align:center"  onunload="onUnload()">
	<br/><br/>
	<i class="fa fa-microphone status_off" aria-hidden="true" style="font-size:5em;" 
	   onClick="sendReleaseToServer()"></i><br/><br/>
	<div id="income_info" style="font-size:0.6em;"></div>
</body>
</html>
