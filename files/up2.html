<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/fileupload.js"></script>
<title>Drag and drop, automatic upload</title>
<style>
#holder { border: 10px dashed #ccc; width: 300px; min-height: 300px; margin: 20px auto;}
#holder.hover { border: 10px dashed #0c0; }
#holder img { display: block; margin: 10px auto; }
#holder p { margin: 10px; font-size: 14px; }
progress { width: 100%; }
progress:after { content: '%'; }
.fail { background: #c00; padding: 2px; color: #fff; }
//.hidden { display: none !important;}
</style>
<script>
$( document ).ready(function() {  
var fileBuffer = {};
var holder = $('body')[0],
    basket = $('#holder')[0],
    //$('#holder')[0],
    tests = {
      filereader: typeof FileReader != 'undefined',
      dnd: 'draggable' in document.createElement('span'),
      formdata: !!window.FormData,
      progress: "upload" in new XMLHttpRequest
    }, 
    support = {
      filereader: document.getElementById('filereader'),
      formdata: document.getElementById('formdata'),
      progress: document.getElementById('progress')
    },
    acceptedTypes = {
      'image/png': true,
      'image/jpeg': true,
      'image/gif': true,
      'video/mp4': true
    },
    progress = document.getElementById('uploadprogress'),
    fileupload = document.getElementById('upload');

"filereader formdata progress".split(' ').forEach(function (api) {
  if (tests[api] === false) {
    support[api].className = 'fail';
  } else {
    // FFS. I could have done el.hidden = true, but IE doesn't support
    // hidden, so I tried to create a polyfill that would extend the
    // Element.prototype, but then IE10 doesn't even give me access
    // to the Element object. Brilliant.
    // support[api].className = 'hidden';
  }
});

function previewfile(file) {
  if (tests.filereader === true && acceptedTypes[file.type] === true) {
    var reader = new FileReader();
    reader.onload = function (event) {
      var image = new Image();
      image.src = event.target.result;
      image.width = 250; // a fake resize
      basket.appendChild(image);
    };

    reader.readAsDataURL(file);
  }  else {
    basket.innerHTML += '<p>Uploaded ' + file.name + ' ' + (file.size ? (file.size/1024|0) + 'K' : '');
    console.log(file);
  }
}
  
     var uploadResult = {};
     function showResult() {
          str = '';
          for(k in uploadResult) {
               if (uploadResult[k].src) {
                    str += k + ':<img src="' + uploadResult[k].src + '" width="300" /><br/>';
               } else {
                    str += k + ' Completed: ' + uploadResult[k].perc + '%<br>';
               }
          }
          $('#upload_result' ).html(str);
     }   

     function showMatrix(v) {
          str = '';
          for(k in v) {
               if (v[k] === 'D') {
                    str += '*';
               } else if  (v[k] === '') { 
                    str += '';
               }else {
                    str += '.';
               }
          }
          $('#upload_mitrix' ).html(str);
     } 
function previewfiles(files) {
    var formData = tests.formdata ? new FormData() : null;
    for (var i = 0; i < files.length; i++) {
      if (tests.formdata) formData.append('file', files[i]);
      previewfile(files[i]);
    }       
}   
function startUp() {
      alert('startUp');   
} 
function readfiles(files) {
  //  debugger;
        var up = [];
         for (var i = 0; i < files.length; i++) {
            up[i] = new FILEUPLOAD(
                {
                    file: files[i],
                    sliceSize : 1024 * 16,
                    threads : 5,
                    progress : function(M, sourceFn, percent_done) {
                         if (!uploadResult[sourceFn]) uploadResult[sourceFn] = {};
                         uploadResult[sourceFn]['perc'] = percent_done;
                         showResult();
                         showMatrix(M);
                         //console.log(me.upload_M);
                    },
                    done : function(M, sourceFn, data) {
                         $("#dbi-file-upload").val('');
                         if (!uploadResult[sourceFn]) uploadResult[sourceFn] = {};
                         uploadResult[sourceFn].src = '/api/sendup.api?fn=' + data.fn + '&nocache=' + new Date().getTime();
                         showResult();
                         showMatrix(M);
                    },
                    error : function() {
                         $('#upload_result' ).html('Upload failure!!!');
                    }

                }
              )
             up[i].upload();
         }
}

if (tests.dnd) { 
  holder.ondragover = function () { 
    this.className = 'hover'; return false; };
  holder.ondragend = function () { 
    this.className = ''; return false; };
  holder.ondrop = function (e) {
    console.log('====ondrop===');
    this.className = '';
    e.preventDefault();
      fileBuffer = e.dataTransfer.files;
    previewfiles(e.dataTransfer.files);
       console.log('====ondrop===>e.dataTransfer.files');
      readfiles(fileBuffer);
  }
} else {
  fileupload.className = 'hidden';
  fileupload.querySelector('input').onchange = function () {
    alert(111);
    readfiles(this.files);
  };
}   
});  
</script>

  </head>
  <body>
    <article>
  <div id="holder">
  </div> 
  <p id="upload" class="hidden"><label>Drag & drop not supported, but you can still upload via this input field:<br><input type="file"></label></p>
  <p id="filereader">File API & FileReader API not supported</p>
  <p id="formdata">XHR2's FormData is not supported</p>
  <p id="progress">XHR2's upload progress isn't supported</p>
  <p>Upload progress: <progress id="uploadprogress" max="100" value="0">0</progress></p>
  <p>Drag an image from your desktop on to the drop zone above to see the browser both render the preview, but also upload automatically to this server.</p>
</article>
  <br/><hr/>
      <a href="Javascript:void(0)" onClick="">test</a>
      <hr/><br/>
<div id = "upload_result"></div>
<div id = "upload_mitrix"></div>
</body>
</html>
