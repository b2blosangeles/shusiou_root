<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/fileupload.js"></script>
</head>
<script>
$( document ).ready(function() {
     var uploadResult = {};
     function showResult() {
          str = '';
          for(k in uploadResult) {
               if (uploadResult[k].src) {
                    str += k + ':<img src="' + uploadResult[k].src + '" width="300" /><br/>';
               } else {
                    str += k + ' Completed: ' + uploadResult[k].perc + '%<br>';
               }
          }
          $('#upload_result' ).html(str);
     }   

     function showMatrix(v) {
          str = '';
          for(k in v) {
               if (v[k] === 'D') {
                    str += '1';
               } else if  (v[k] === '') { 
                    str += 'o';
               }else {
                    str += 'p';
               }
          }
          $('#upload_mitrix' ).html(str);
     }        
     
     $('#dbi-file-upload-submit').on( 'click', function(event) {
         event.preventDefault();
          uploadResult = {}
         var files = $('#dbi-file-upload' )[0].files; 
         up = [];
         for (var i = 0; i < files.length; i++) {
            up[i] = new FILEUPLOAD(
                {
                    file: files[i],
                    sliceSize : 1024 * 1,
                    threads : 5,
                    progress : function(M, sourceFn, percent_done) {
                         if (!uploadResult[sourceFn]) uploadResult[sourceFn] = {};
                         uploadResult[sourceFn]['perc'] = percent_done;
                         showResult();
                         showMatrix(M);
                    },
                    done : function(M, sourceFn, data) {
                         $("#dbi-file-upload").val('');
                         if (!uploadResult[sourceFn]) uploadResult[sourceFn] = {};
                         uploadResult[sourceFn].src = '/api/sendup.api?fn=' + data.fn + '&nocache=' + new Date().getTime();
                         showResult();
                         showMatrix(M);
                    },
                    error : function() {
                         $('#upload_result' ).html('Upload failure!!!');
                    }

                }
              )
             up[i].upload();
         }
     });
     
});
    
</script>
<body>
<form>
   <p id="dbi-upload-progress">Please select a file and click "Upload" to continue.</p>
   <input id="dbi-file-upload" type="file" name="dbi_import_file" multiple /><br><br>
   <input id="dbi-file-upload-submit" class="button button-primary" type="button" value="Upload" />
       
</form>
<br/><hr/><br/>
<div id = "upload_result"></div>
<div id = "upload_mitrix"></div>
</body>
</html>
