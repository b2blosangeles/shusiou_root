<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<script>
$( document ).ready(function() {
    var reader = {};
    var file = {};
    var slice_size = 1024 * 10;
    var size_done = 0;
    
    var img = '';
    
    function start_upload( event ) {
        event.preventDefault();
        reader = new FileReader();
        file = $('#dbi-file-upload' )[0].files[0];
        console.log('filesize:' + file.size);
        upload_file(0);
    }
    $( '#dbi-file-upload-submit' ).on( 'click', start_upload ); 
    function upload_file( start ) {
        var next_slice = start + slice_size + 1;
        var blob = file.slice( start, next_slice );
        var size_done = next_slice - 1; 
        var percent_done = Math.min(Math.floor( ( size_done / file.size ) * 100 ), 100);
        $('#upload_completed' ).html('Completed: ' + percent_done + '%' )
        
        reader.onloadend = function( event ) {
            var d = event.target.result.split( ';base64,');
            img += (!start) ? event.target.result :  d[1];
            console.log(event.target.result);
            if ( event.target.readyState === FileReader.DONE ) {
                    if ( next_slice < file.size ) { 
                        setTimeout(
                            function() {
                               upload_file( next_slice );
                            }, Math.floor((Math.random() * 100) + 1)
                        )
                  } else {
                      //  $('img').attr('src',img);
                  }
            }
        };        
        reader.readAsDataURL( blob );
    }

});

</script>
<body>
<form>
    <p id="dbi-upload-progress">Please select a file and click "Upload" to continue.</p>
        <div id = "upload_completed"></div>
        <input id="dbi-file-upload" type="file" name="dbi_import_file" /><br><br>
        <input id="dbi-file-upload-submit" class="button button-primary" type="button" value="Upload" />
        <img src=""/>
</form>
</body>
</html>
